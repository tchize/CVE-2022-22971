#/bin/sh
echo "building rabbitmq docker image with stomp enabled"
docker build  -t hms-ewon/rabbitwithstomp rabbit
docker stop some-rabbit
docker rm some-rabbit
echo "starting rabbitmq docker image"
docker run -d --hostname my-rabbit --name some-rabbit \
-p 4369:4369/tcp \
-p 5671:5671/tcp \
-p 5672:5672/tcp \
-p 15671:15671/tcp \
-p 15672:15672/tcp \
-p 15691:15691/tcp \
-p 15692:15692/tcp \
-p 25672:25672/tcp \
-p 61613:61613/tcp \
-e RABBITMQ_DEFAULT_USER=guest -e RABBITMQ_DEFAULT_PASS=guest hms-ewon/rabbitwithstomp

echo wait for startup
sleep 60
IP=localhost
curl 'http://'$IP':15672/api/exchanges/%2F/test' \
  -X 'PUT' \
  -H 'authorization: Basic Z3Vlc3Q6Z3Vlc3Q=' \
  -H 'content-type: application/json' \
  -H 'Accept: */*' \
  --data-raw '{"vhost":"/","name":"test","type":"topic","durable":"true","auto_delete":"false","internal":"false","arguments":{}}' \
  --insecure
echo 'exchange "/test" created'
pushd springstomp
echo 'starting spring, exploit will be available at http://localhost:8080/websocket.html'
mvn clean spring-boot:run -Drun.arguments="-Dstomp.host=$IP"
