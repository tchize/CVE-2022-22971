<html>
<head>
	<style>
		div {
			border: 1px solid black;
			display: inline-block;
		}
	</style>
	<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script>
		function spamSocket(maxcount, delay) {
			let output = $("<div><p>Starting one run for " + maxcount + " connect on a single web socket<p></div>")
			let counterOut = $("<p>status: pending</p>");
			output.appendTo("#output")
			counterOut.appendTo(output);
			let count = 0;
			let socket = new WebSocket("ws://localhost:8080/ws/websocket");
			let doConnect = function() {
				if (count < maxcount) {
					socket.send('CONNECT\naccept-version:1.1,1.2\n\n\u0000');
				}
				count++;
			}
			socket.onopen = function(e) {
				console.log("[open] Connection established");
				console.log("Sending stomp <CONNECT> to server");
				doConnect();
			};

			socket.onmessage = function(event) {
				//console.log(event.data);
				//console.log(`[message] Data received from server: ${event.data}`);
				if (event.data.indexOf("CONNECTED") !== -1) {
					counterOut.text("Status: " + count + "/" + maxcount);
					//console.log("connected, subscribing to a basic exchange");
					socket.send('SUBSCRIBE\nack:auto\nid:random\ndestination:/exchange/test/random\n\n\u0000');
					setTimeout(doConnect,delay);
				}
			};
		}
	</script>
</head>
<body>
	<div id="output">

	</div>
	<p>
		#Connect <input type="text" id="count" value="15"></input><br/>
		#delays <input type="text" id="delay" value="500"></input>
		<button onclick="spamSocket(parseInt($('#count').val()), parseInt($('#delay').val()))">Send connect spam</button>
	</p>

<p>
	Go to <a href="http://localhost:15672/#/queues" target="_blank">http://localhost:15672/#/queues</a> (password: guest/guest) to check queue leak.
</p>
</body>
</html>